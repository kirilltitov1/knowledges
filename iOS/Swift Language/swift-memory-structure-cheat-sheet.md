---
title: –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ–±—ä–µ–∫—Ç–æ–≤ Swift –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–∞–º—è—Ç—å—é
type: cheat-sheet
topics: [Memory Management, Swift Runtime, Value vs Reference Types]
subtopic: swift-memory-structure
status: draft
level: intermediate
platforms: [iOS, macOS, watchOS, tvOS]
ios_min: "10.0"
duration: 45m
tags: [swift, memory-structure, value-types, reference-types, arc, copy-on-write]
---

# üß† –®–ø–∞—Ä–≥–∞–ª–∫–∞: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–æ–≤ Swift –∏ –ø–∞–º—è—Ç—å

## –í–≤–µ–¥–µ–Ω–∏–µ

–≠—Ç–∞ —à–ø–∞—Ä–≥–∞–ª–∫–∞ –æ–±—ä—è—Å–Ω—è–µ—Ç, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞–º—è—Ç—å –≤ Swift, —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –∏ –∫–ª–∞—Å—Å–∞–º–∏, –∏ –∫–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ RAM. Swift –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å Objective-C.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä—ã vs –ö–ª–∞—Å—Å—ã (Value vs Reference Types)

#### –°—Ç—Ä—É–∫—Ç—É—Ä—ã (Struct) - Value Types
- **–ö–æ–ø–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–∏** (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é)
- **–†–∞–∑–º–µ—â–∞—é—Ç—Å—è –Ω–∞ —Å—Ç–µ–∫–µ** (–µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç)
- **–ù–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –ø–æ–¥—Å—á–µ—Ç–µ —Å—Å—ã–ª–æ–∫ ARC**
- **–ò–º–µ—é—Ç –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä?** –ù–µ—Ç, –Ω–æ –º–æ–≥—É—Ç –∏–º–µ—Ç—å `deinit`, –µ—Å–ª–∏ –±—É–¥—É—Ç ~Copyable

```swift
struct Point {
    var x, y: Int

    // –°—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å –º–µ—Ç–æ–¥—ã
    func distance(to other: Point) -> Double {
        return sqrt(Double((x - other.x) * (x - other.x) + (y - other.y) * (y - other.y)))
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
var point1 = Point(x: 0, y: 0)
var point2 = point1  // ‚Üê –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é!
point2.x = 5         // –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ point1

print(point1.x) // 0
print(point2.x) // 5
```

#### –ö–ª–∞—Å—Å—ã (Class) - Reference Types
- **–ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–æ —Å—Å—ã–ª–∫–µ** (–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª—å)
- **–†–∞–∑–º–µ—â–∞—é—Ç—Å—è –≤ –∫—É—á–µ** –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –ñ–¶ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –º–æ–∂–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–ª–æ–∂–∏—Ç—å –≤ —Å—Ç–µ–∫. 
- **–£—á–∞—Å—Ç–≤—É—é—Ç –≤ ARC** (–ø–æ–¥—Å—á–µ—Ç —Å–∏–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫)
- **–ò–º–µ—é—Ç –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã**

```swift
class Person {
    var name: String

    init(name: String) {
        self.name = name
        print("Person \(name) initialized")
    }

    deinit {
        print("Person \(name) deinitialized")
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
var person1 = Person(name: "Alice")  // reference count = 1
var person2 = person1                 // reference count = 2
person2.name = "Bob"                  // –≤–ª–∏—è–µ—Ç –Ω–∞ person1 —Ç–æ–∂–µ!

print(person1.name) // "Bob"
print(person2.name) // "Bob"
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞–º—è—Ç—å –≤ Swift

### –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏

#### –°—Ç—Ä—É–∫—Ç—É—Ä—ã (Value Types)
```swift
// –ú–∞–ª–µ–Ω—å–∫–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–≥—É—Ç —Ä–∞–∑–º–µ—â–∞—Ç—å—Å—è –ø—Ä—è–º–æ –≤ —É–∫–∞–∑–∞—Ç–µ–ª–µ –∏–ª–∏ –Ω–∞ —Å—Ç–µ–∫–µ
struct SmallStruct {
    var value: Int
}

// –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
var small = SmallStruct(value: 42)
// –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–æ:
// 1. –ü—Ä—è–º–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (inlined)
// 2. –ù–∞ —Å—Ç–µ–∫–µ
// 3. –í –∫—É—á–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

struct LargeStruct {
    var values: [Int] // –±–æ–ª—å—à–æ–π –º–∞—Å—Å–∏–≤
}
// –í—Å–µ–≥–¥–∞ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –∫—É—á–µ –∏–∑-–∑–∞ —Ä–∞–∑–º–µ—Ä–∞
```

#### –ö–ª–∞—Å—Å—ã (Reference Types)
```swift
// –í—Å–µ–≥–¥–∞ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –≤ –∫—É—á–µ
class MyClass {
    var property: Int
}

let obj = MyClass()  // –í –∫—É—á–µ

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ –≤ –ø–∞–º—è—Ç–∏:
// ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
// ‚îÇ           Heap Object Header            ‚îÇ
// ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
// ‚îÇ           Reference Count               ‚îÇ ‚Üê ARC tracking
// ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
// ‚îÇ           Property 1                    ‚îÇ
// ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
// ‚îÇ           Property 2                    ‚îÇ
// ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
// ‚îÇ           ...                           ‚îÇ
// ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ heap-–æ–±—ä–µ–∫—Ç–∞ Swift (metadata/isa, refCounts)

Swift-–∫–ª–∞—Å—Å—ã ‚Äî —ç—Ç–æ heap-–æ–±—ä–µ–∫—Ç—ã —Å ¬´–∑–∞–≥–æ–ª–æ–≤–∫–æ–º¬ª –∏–∑ –¥–≤—É—Ö –º–∞—à–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤: —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞ –∏ –±–∏—Ç–æ–≤–æ-—É–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ —Å—Å—ã–ª–æ–∫.

```c
// –£–ø—Ä–æ—â—ë–Ω–Ω–æ (–ø–æ –º–æ—Ç–∏–≤–∞–º open-source Swift runtime):
struct HeapObjectHeader {
    uintptr_t metadata;   // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å–∞
    uintptr_t refCounts;  // –°–∏–ª—å–Ω—ã–µ/–Ω–µ–≤–ª–∞–¥–µ–ª—å—á–µ—Å–∫–∏–µ —Å—á—ë—Ç—á–∏–∫–∏ + —Ñ–ª–∞–≥–∏
};

struct HeapObject {
    struct HeapObjectHeader header;
    // –î–∞–ª–µ–µ ‚Äî –ø–æ–ª—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (—Å–≤–æ–π—Å—Ç–≤–∞ –∫–ª–∞—Å—Å–∞)
};
```

- **metadata**: —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ ¬´class/type metadata¬ª. –ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö Apple —Å–æ–≤–º–µ—Å—Ç–∏–º —Å `objc isa` ‚Äî —Ç.–µ. `object_getClass(_:)` —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è Swift-–∫–ª–∞—Å—Å–æ–≤. –ù–∞ –Ω–µ-ObjC –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö —ç—Ç–æ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —á–∏—Å—Ç–æ Swift-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.
- **refCounts**: –±–∏—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è ARC:
  - —Å–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (strong) –∏ –Ω–µ–≤–ª–∞–¥–µ–ª—å—á–µ—Å–∫–∏–µ (unowned) —Å—á—ë—Ç—á–∏–∫–∏,
  - —Ñ–ª–∞–≥–∏: ¬´–æ–±—ä–µ–∫—Ç –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è¬ª, ¬´–±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç¬ª –∏ —Ç.–ø.,
  - –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏/—Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

#### Side tables –∏ weak-—Ç–∞–±–ª–∏—Ü–∞

- **Weak** —Å—Å—ã–ª–∫–∏ –Ω–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç strong count –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–ª–∞–±–æ–π —Ç–∞–±–ª–∏—Ü–µ. –ü—Ä–∏ –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ weak –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω—É–ª—è—é—Ç—Å—è.
- **Unowned** —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ refCounts; –ø–æ—Å–ª–µ –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø –∫ –Ω–∏–º –≤—ã–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—à (trap), –ø–æ—ç—Ç–æ–º—É –æ–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ª–æ–≥–∏–∫–µ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏.
- –ü—Ä–∏ –±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤/–æ—Å–æ–±—ã—Ö —Ñ–ª–∞–≥–∞—Ö —Ä–∞–Ω—Ç–∞–π–º –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ¬´–≤–Ω–µ—à–Ω–µ–µ¬ª —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —á–∞—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∞–Ω–∞–ª–æ–≥ ¬´side table¬ª).

#### Obj-C interop –∏ ¬´isa¬ª

- –ö–ª–∞—Å—Å—ã Swift —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å Obj-C —Ä–∞–Ω—Ç–∞–π–º–æ–º –Ω–∞ iOS/macOS: –ø–µ—Ä–≤—ã–π word –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–ª–∞—Å—Å (metadata), —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å `isa`.
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
  - `object_getClass(obj)`, `type(of: obj)` –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏—Å–ø–µ—Ç—á–∏–Ω–≥ —á–µ—Ä–µ–∑ Obj-C —Ä–∞–Ω—Ç–∞–π–º,
  - –±—Ä–∏–¥–∂–∏–Ω–≥ ARC –º–µ–∂–¥—É Swift –∏ Obj-C,
  - –º–µ—Ç–æ–¥-—Ä–µ–∑–æ–ª–≤–∏–Ω–≥/–∫–µ—à —É Obj-C-–∫–ª–∞—Å—Å–æ–≤-–ø—Ä–µ–¥–∫–æ–≤ (`NSObject`).

#### –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤ LLDB: —á—Ç–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–∞

```bash
# –ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è RC)
(lldb) expr -l Swift -- import Foundation
(lldb) expr -l Swift -- let p = Unmanaged.passUnretained(person).toOpaque()
(lldb) expr -l Swift -- p

# –ü—Ä–æ—á–∏—Ç–∞—Ç—å –¥–≤–∞ –ø–µ—Ä–≤—ã—Ö machine word: metadata –∏ refCounts
(lldb) memory read -s8 -c2 p

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å–∞ —á–µ—Ä–µ–∑ Obj-C
(lldb) expr -l Swift -- object_getClass(person)
(lldb) expr -l Swift -- type(of: person)
```

#### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- **–°—Ç—Ä–æ–∫–∏ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏** –≤ Swift ‚Äî value types —Å COW: –∏—Ö ¬´–¥–∞–Ω–Ω—ã–µ¬ª —á–∞—Å—Ç–æ –∂–∏–≤—É—Ç –≤ –∫—É—á–µ, –Ω–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ‚Äî —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (value), –Ω–µ –∫–ª–∞—Å—Å.
- **Small/Inline –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–º–∞–ª—ã–µ —Å—Ç—Ä–æ–∫–∏¬ª) –º–æ–≥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤ –∫—É—á–µ.
- **RC –Ω–∞–±–ª—é–¥–µ–Ω–∏—è**: `CFGetRetainCount` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º –¥–ª—è Swift-–æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑-–∑–∞ –∏–Ω–ª–∞–π–Ω–æ–≤—ã—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π; –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

## ARC –≤ Swift (Automatic Reference Counting)

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ARC

```swift
class Person {
    var passport: Passport?

    deinit {
        print("Person deinitialized")
    }
}

class Passport {
    var owner: Person?  // Strong reference

    deinit {
        print("Passport deinitialized")
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
var person = Person()    // RC = 1
var passport = Passport() // RC = 1

person.passport = passport  // person -> passport (RC = 2)
passport.owner = person     // passport -> person (RC = 2)

// RETAIN CYCLE! –ù–∏–∫—Ç–æ –Ω–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω
```

### –†–∞–∑—Ä—ã–≤ —Ü–∏–∫–ª–æ–≤ —É–¥–µ—Ä–∂–∞–Ω–∏—è

```swift
// –†–µ—à–µ–Ω–∏–µ 1: weak —Å—Å—ã–ª–∫–∏
class Passport {
    weak var owner: Person?  // –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç RC
}

// –†–µ—à–µ–Ω–∏–µ 2: unowned —Å—Å—ã–ª–∫–∏
class Person {
    var passport: Passport?

    deinit {
        print("Person deinitialized")
    }
}

class Passport {
    unowned var owner: Person  // –ù–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç RC

    deinit {
        print("Passport deinitialized")
    }
}
```

## Copy-on-Write (COW) –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç COW

```swift
var array1 = [1, 2, 3, 4, 5]  // –ò—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤
var array2 = array1           // –ù–µ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è, shared buffer

print(array1 === array2)      // false (—Ä–∞–∑–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
print(array1.count)           // 5

// –ü—Ä–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
array2.append(6)              // –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ array2

print(array1)  // [1, 2, 3, 4, 5]
print(array2)  // [1, 2, 3, 4, 5, 6]
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è COW –≤—Ä—É—á–Ω—É—é

```swift
struct MyArray {
    private var _storage: ArrayStorage

    var count: Int {
        return _storage.count
    }

    private class ArrayStorage {
        var values: [Int]
        var refCount = 1

        init(values: [Int]) {
            self.values = values
        }
    }

    // Copy-on-Write –ª–æ–≥–∏–∫–∞
    private mutating func ensureUnique() {
        if _storage.refCount > 1 {
            let values = _storage.values
            _storage = ArrayStorage(values: values)
        }
    }

    mutating func append(_ value: Int) {
        ensureUnique()
        _storage.values.append(value)
    }
}
```

## –ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ RAM

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä (Value Types)

```swift
struct Point {
    var x, y: Int
}

var point = Point(x: 10, y: 20)

// –í LLDB:
(lldb) frame variable point      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
(lldb) frame variable -L point   // –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
(lldb) p point                   // –ù–∞–ø–µ—á–∞—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
(lldb) p &point                  // –ê–¥—Ä–µ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
```

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ (Reference Types)

```swift
class Person {
    var name: String
    init(name: String) { self.name = name }
}

let person = Person(name: "Alice")

// –í LLDB:
(lldb) po person                 // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç
(lldb) p person                  // –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ –≤ –∫—É—á–µ
(lldb) p &person                 // –ê–¥—Ä–µ—Å —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç–µ–∫–µ
(lldb) p person.name             // –î–æ—Å—Ç—É–ø –∫ —Å–≤–æ–π—Å—Ç–≤—É
```

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –æ–±—ä–µ–∫—Ç–æ–≤

```swift
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ –∫–ª–∞—Å—Å–∞ –≤ –ø–∞–º—è—Ç–∏
class MyClass {
    let id: Int
    var name: String

    init(id: Int, name: String) {
        self.id = id
        self.name = name
    }
}

// –í LLDB –º–æ–∂–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å:
// Heap object header + —Å–≤–æ–π—Å—Ç–≤–∞
(lldb) p *(MyClass *)person      // –†–∞–∑—ã–º–µ–Ω–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç
```

## –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Swift

### 1. Implicitly Shared (COW) –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```swift
// Array, Dictionary, Set –∏—Å–ø–æ–ª—å–∑—É—é—Ç COW
var array1 = [1, 2, 3]
var array2 = array1      // –ù–µ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è

array2.append(4)         // –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ array2
```

### 2. Value Types –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö

```swift
func modifyStruct(_ point: Point) {
    var point = point    // –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è
    point.x = 100        // –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª
}

func modifyClass(_ person: Person) {
    person.name = "Bob"  // –ò–∑–º–µ–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª
}
```

### 3. @escaping –∑–∞–º—ã–∫–∞–Ω–∏—è

```swift
class NetworkManager {
    var handlers: [() -> Void] = []

    func fetchData(completion: @escaping () -> Void) {
        handlers.append(completion)  // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è strongly
        // –ë–µ–∑ @escaping –∑–∞–º—ã–∫–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∂–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
    }
}

// –†–µ—à–µ–Ω–∏–µ –¥–ª—è —Ü–∏–∫–ª–æ–≤ —É–¥–µ—Ä–∂–∞–Ω–∏—è
func fetchData(completion: @escaping () -> Void) {
    handlers.append { [weak self] in
        completion()  // —Å–ª–∞–±–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ self
    } }
```

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã LLDB

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä

```bash
(lldb) frame variable point
(lldb) p sizeof(Point)           # –†–∞–∑–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
(lldb) p &point                  # –ê–¥—Ä–µ—Å –Ω–∞ —Å—Ç–µ–∫–µ
(lldb) p point.x                 # –î–æ—Å—Ç—É–ø –∫ –ø–æ–ª—é
```

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤

```bash
(lldb) po person                 # –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç
(lldb) p person                  # –ê–¥—Ä–µ—Å –≤ –∫—É—á–µ
(lldb) p person.name             # –°–≤–æ–π—Å—Ç–≤–æ
(lldb) p *(MyClass *)person      # –†–∞–∑—ã–º–µ–Ω–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç
```

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ ARC

```swift
// –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å reference count
(lldb) p person                 # –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
(lldb) expr CFGetRetainCount(person)  # –ü–æ–ª—É—á–∏—Ç—å RC (unsafe_unretained)
```

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–ß–µ–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç –∫–ª–∞—Å—Å–æ–≤?** –°—Ç—Ä—É–∫—Ç—É—Ä—ã - value types (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ), –∫–ª–∞—Å—Å—ã - reference types (—Å—Å—ã–ª–∫–∏)
2. **–ì–¥–µ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã?** –ù–∞ —Å—Ç–µ–∫–µ –∏–ª–∏ –≤ —É–∫–∞–∑–∞—Ç–µ–ª–µ (–µ—Å–ª–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ)
3. **–ì–¥–µ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –∫–ª–∞—Å—Å—ã?** –í—Å–µ–≥–¥–∞ –≤ –∫—É—á–µ
4. **–ß—Ç–æ —Ç–∞–∫–æ–µ ARC?** Automatic Reference Counting - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç —Å–∏–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
5. **–ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–æ–≤ —É–¥–µ—Ä–∂–∞–Ω–∏—è?** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å weak/unowned —Å—Å—ã–ª–∫–∏
6. **–ß—Ç–æ —Ç–∞–∫–æ–µ Copy-on-Write?** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
7. **–ö–∞–∫ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å –≤ LLDB?** –ß–µ—Ä–µ–∑ `po`, `p`, `frame variable`

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã LLDB –¥–ª—è Swift

```bash
# –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
(lldb) frame variable -L variableName
(lldb) p variableName
(lldb) p &variableName
(lldb) p sizeof(TypeName)

# –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
(lldb) po object
(lldb) p *(ClassName *)object
(lldb) p object.property

# –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
(lldb) x/gx 0xADDRESS
(lldb) malloc_history $pid 0xADDRESS
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–∞–º—è—Ç–∏ –≤ Swift –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è:

- **–í—ã–±–æ—Ä–∞ –º–µ–∂–¥—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –∏ –∫–ª–∞—Å—Å–∞–º–∏** (value vs reference semantics)
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (Copy-on-Write, —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏)
- **–ò–∑–±–µ–≥–∞–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏** (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ weak/unowned)
- **–û—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é** (–ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤)

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø Swift:** "Value types –¥–ª—è –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏, reference types –¥–ª—è —Ä–∞–∑–¥–µ–ª—è–µ–º–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"

## üìÖ –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π

### –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- **–î–∞—Ç–∞**: 2024-01-15
- **–í–µ—Ä—Å–∏—è**: Swift 5.9, iOS 17.2, Xcode 15.2
- **–ò—Å—Ç–æ—á–Ω–∏–∫–∏**:
  - [The Swift Programming Language - Memory Safety](https://docs.swift.org/swift-book/LanguageGuide/MemorySafety.html)
  - [WWDC: Understanding Swift Performance](https://developer.apple.com/videos/play/wwdc2016/416/)
  - [Swift Blog: Value and Reference Types](https://swift.org/blog/value-and-reference-types/)

### –ü–ª–∞–Ω —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã —Å async/await –∏ –ø–∞–º—è—Ç—å—é
- –û–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∏—á Swift 6
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ Copy-on-Write —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π
