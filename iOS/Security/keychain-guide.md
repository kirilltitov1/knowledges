---
type: "guide"
status: "draft"
level: "intermediate"
title: "Keychain Guide"
---

# üîê Keychain - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Keychain Services –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–û—Å–Ω–æ–≤—ã Keychain](#–æ—Å–Ω–æ–≤—ã-keychain)
- [–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è](#—Ç–∏–ø—ã-–¥–∞–Ω–Ω—ã—Ö-–¥–ª—è-—Ö—Ä–∞–Ω–µ–Ω–∏—è)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–¥–æ—Å—Ç—É–ø–∞)
- [–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è](#–±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)
- [–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å iCloud](#—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è-—Å-icloud)
- [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞](#–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–¥–∞)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)

## –û—Å–Ω–æ–≤—ã Keychain

### –ß—Ç–æ —Ç–∞–∫–æ–µ Keychain Services?

**Keychain Services** ‚Äî —ç—Ç–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Apple –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ç–∞–∫–æ–π –∫–∞–∫:
- –ü–∞—Ä–æ–ª–∏ –∏ —Ç–æ–∫–µ–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ö–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Keychain

1. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** - –¥–∞–Ω–Ω—ã–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞**
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å iCloud** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏–æ–º–µ—Ç—Ä–∏–µ–π**
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Keychain

```swift
// –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keychain
import Security

// –ö–ª–∞—Å—Å—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ Keychain
enum KeychainClass {
    case genericPassword    // –û–±—â–∏–µ –ø–∞—Ä–æ–ª–∏
    case internetPassword   // –ü–∞—Ä–æ–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
    case certificate        // –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    case key                // –ö–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    case identity           // –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç + –∫–ª—é—á)
}
```

## –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è

### 1. Generic Passwords

–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```swift
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
let query: [String: Any] = [
    kSecClass as String: kSecClassGenericPassword,
    kSecAttrAccount as String: "user_token",
    kSecAttrService as String: "com.myapp.auth",
    kSecValueData as String: tokenData
]

let status = SecItemAdd(query as CFDictionary, nil)
```

### 2. Internet Passwords

–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–µ–±-—Å–∞–π—Ç–æ–≤:

```swift
let query: [String: Any] = [
    kSecClass as String: kSecClassInternetPassword,
    kSecAttrServer as String: "api.myapp.com",
    kSecAttrAccount as String: username,
    kSecAttrPort as String: 443,
    kSecAttrProtocol as String: kSecAttrProtocolHTTPS,
    kSecValueData as String: passwordData
]
```

### 3. Certificates

–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

```swift
let query: [String: Any] = [
    kSecClass as String: kSecClassCertificate,
    kSecAttrLabel as String: "My App Certificate",
    kSecValueRef as String: certificateRef
]
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞

### –£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö

```swift
// –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã
enum KeychainAccessibility {
    case whenUnlocked              // –î–æ—Å—Ç—É–ø–µ–Ω –∫–æ–≥–¥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
    case whenUnlockedThisDeviceOnly // –¢–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    case whenPasscodeSetThisDeviceOnly // –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–¥–∞-–ø–∞—Ä–æ–ª—è
    case afterFirstUnlock          // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    case afterFirstUnlockThisDeviceOnly // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, —Ç–æ–ª—å–∫–æ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    case always                    // –í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
    case alwaysThisDeviceOnly      // –í—Å–µ–≥–¥–∞, —Ç–æ–ª—å–∫–æ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    case accessibleWhenPasscodeSetThisDeviceOnly // –ö–æ–≥–¥–∞ –∫–æ–¥-–ø–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
}
```

### –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞

```swift
let query: [String: Any] = [
    kSecClass as String: kSecClassGenericPassword,
    kSecAttrAccount as String: "sensitive_data",
    kSecAttrService as String: "com.myapp.security",
    kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
    kSecValueData as String: sensitiveData
]
```

## –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### Local Authentication Framework

```swift
import LocalAuthentication

class BiometricManager {
    private let context = LAContext()

    func authenticateUser(completion: @escaping (Bool, Error?) -> Void) {
        var error: NSError?

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∏–æ–º–µ—Ç—Ä–∏–∏
        if context.canEvaluatePolicy(.deviceOwnerAuthenticationWithBiometrics, error: &error) {
            let reason = "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º"

            context.evaluatePolicy(.deviceOwnerAuthenticationWithBiometrics,
                                 localizedReason: reason) { success, error in
                DispatchQueue.main.async {
                    completion(success, error)
                }
            }
        } else {
            completion(false, error)
        }
    }
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Keychain

```swift
class SecureDataManager {
    private let biometricManager = BiometricManager()

    func saveDataWithBiometricProtection(_ data: Data, key: String) {
        biometricManager.authenticateUser { [weak self] success, error in
            guard success else {
                print("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: \(error?.localizedDescription ?? "")")
                return
            }

            self?.saveToKeychain(data, forKey: key)
        }
    }

    private func saveToKeychain(_ data: Data, forKey key: String) {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: key,
            kSecAttrService as String: "com.myapp.securedata",
            kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
            kSecValueData as String: data
        ]

        SecItemDelete(query as CFDictionary) // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        let status = SecItemAdd(query as CFDictionary, nil)

        if status != errSecSuccess {
            print("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Keychain: \(status)")
        }
    }

    func retrieveData(forKey key: String, completion: @escaping (Data?) -> Void) {
        biometricManager.authenticateUser { success, error in
            guard success else {
                completion(nil)
                return
            }

            let data = self.retrieveFromKeychain(forKey: key)
            completion(data)
        }
    }

    private func retrieveFromKeychain(forKey key: String) -> Data? {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: key,
            kSecAttrService as String: "com.myapp.securedata",
            kSecReturnData as String: true
        ]

        var result: AnyObject?
        let status = SecItemCopyMatching(query as CFDictionary, &result)

        if status == errSecSuccess {
            return result as? Data
        }

        return nil
    }
}
```

## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å iCloud

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```swift
// –í Capabilities –ø—Ä–æ–µ–∫—Ç–∞ –≤–∫–ª—é—á–∏—Ç–µ Keychain Sharing
// –í entitlements –¥–æ–±–∞–≤—å—Ç–µ:

<key>keychain-access-groups</key>
<array>
    <string>$(AppIdentifierPrefix)com.myapp.keychain</string>
</array>
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã–π Keychain

```swift
func saveDataWithiCloudSync(_ data: Data, key: String) {
    let query: [String: Any] = [
        kSecClass as String: kSecClassGenericPassword,
        kSecAttrAccount as String: key,
        kSecAttrService as String: "com.myapp.icloudsync",
        kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlocked,
        kSecAttrSynchronizable as String: true, // –í–∫–ª—é—á–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
        kSecValueData as String: data
    ]

    SecItemDelete(query as CFDictionary)
    let status = SecItemAdd(query as CFDictionary, nil)

    if status != errSecSuccess {
        print("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π: \(status)")
    }
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### 1. –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```swift
class AuthTokenManager {
    private let service = "com.myapp.authtokens"

    func saveToken(_ token: String, forUser userId: String) {
        guard let tokenData = token.data(using: .utf8) else { return }

        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: userId,
            kSecAttrService as String: service,
            kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
            kSecValueData as String: tokenData
        ]

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        SecItemDelete(query as CFDictionary)

        let status = SecItemAdd(query as CFDictionary, nil)
        if status != errSecSuccess {
            print("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: \(status)")
        }
    }

    func getToken(forUser userId: String) -> String? {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: userId,
            kSecAttrService as String: service,
            kSecReturnData as String: true
        ]

        var result: AnyObject?
        let status = SecItemCopyMatching(query as CFDictionary, &result)

        if status == errSecSuccess, let data = result as? Data {
            return String(data: data, encoding: .utf8)
        }

        return nil
    }

    func deleteToken(forUser userId: String) {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: userId,
            kSecAttrService as String: service
        ]

        SecItemDelete(query as CFDictionary)
    }
}
```

### 2. –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```swift
class EncryptionKeyManager {
    private let service = "com.myapp.encryptionkeys"

    func generateAndSaveEncryptionKey() -> Data? {
        var keyData = Data(count: 32)
        let result = keyData.withUnsafeMutableBytes {
            SecRandomCopyBytes(kSecRandomDefault, 32, $0.baseAddress!)
        }

        guard result == errSecSuccess else { return nil }

        let query: [String: Any] = [
            kSecClass as String: kSecClassKey,
            kSecAttrApplicationTag as String: "com.myapp.encryptionkey",
            kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
            kSecValueData as String: keyData
        ]

        SecItemDelete(query as CFDictionary)
        let status = SecItemAdd(query as CFDictionary, nil)

        return status == errSecSuccess ? keyData : nil
    }

    func getEncryptionKey() -> Data? {
        let query: [String: Any] = [
            kSecClass as String: kSecClassKey,
            kSecAttrApplicationTag as String: "com.myapp.encryptionkey",
            kSecReturnData as String: true
        ]

        var result: AnyObject?
        let status = SecItemCopyMatching(query as CFDictionary, &result)

        return status == errSecSuccess ? result as? Data : nil
    }
}
```

### 3. –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π

```swift
class PaymentManager {
    private let secureManager = SecureDataManager()

    func makeSecurePayment(amount: Double, cardData: CardData) {
        // –°–Ω–∞—á–∞–ª–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        secureManager.authenticateWithBiometrics { [weak self] success in
            guard success else {
                self?.handlePaymentError("–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å")
                return
            }

            // –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞
            let paymentData = PaymentData(amount: amount, card: cardData)
            self?.processPayment(paymentData)
        }
    }

    private func processPayment(_ paymentData: PaymentData) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        NetworkManager.shared.makePayment(paymentData) { result in
            switch result {
            case .success:
                self.handlePaymentSuccess()
            case .failure(let error):
                self.handlePaymentError(error.localizedDescription)
            }
        }
    }
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –¥–æ—Å—Ç—É–ø–∞

```swift
// –î–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
kSecAttrAccessibleWhenUnlocked

// –î–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
kSecAttrAccessibleWhenUnlockedThisDeviceOnly

// –î–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
kSecAttrAccessibleAfterFirstUnlock

// –î–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
kSecAttrAccessibleAlways
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```swift
func handleKeychainError(_ status: OSStatus) {
    switch status {
    case errSecSuccess:
        print("–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
    case errSecDuplicateItem:
        print("–≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    case errSecItemNotFound:
        print("–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    case errSecAuthFailed:
        print("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏")
    case errSecInteractionNotAllowed:
        print("–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ")
    case errSecDecode:
        print("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è")
    default:
        print("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ Keychain: \(status)")
    }
}
```

### 3. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –¥–µ–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏

```swift
class AppLifecycleManager {
    static let shared = AppLifecycleManager()

    func cleanupSensitiveData() {
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ Keychain –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrService as String: "com.myapp"
        ]

        SecItemDelete(query as CFDictionary)

        // –û—á–∏—Å—Ç–∫–∞ –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        let keyQuery: [String: Any] = [
            kSecClass as String: kSecClassKey,
            kSecAttrApplicationTag as String: "com.myapp"
        ]

        SecItemDelete(keyQuery as CFDictionary)
    }
}
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–∞ –∫ Keychain

```swift
// –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ Keychain
func enableKeychainLogging() {
    // –î–æ–±–∞–≤—å—Ç–µ –≤ —Å—Ö–µ–º—É –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
    // Environment Variables: OS_ACTIVITY_MODE = disable
    // –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Console.app –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
}
```

## –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞

```swift
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã
kSecAttrAccessibleAlways

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
kSecAttrAccessibleWhenUnlockedThisDeviceOnly
```

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```swift
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
SecItemAdd(query as CFDictionary, nil)

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
let status = SecItemAdd(query as CFDictionary, nil)
if status != errSecSuccess {
    handleKeychainError(status)
}
```

### 3. –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

```swift
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ Keychain
let largeFileData = try Data(contentsOf: largeFileURL)
saveToKeychain(largeFileData) // Keychain –Ω–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
let encryptionKey = generateEncryptionKey()
saveEncryptionKeyToKeychain(encryptionKey)
encryptFile(largeFileURL, withKey: encryptionKey)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Keychain

### 1. –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ Keychain –¥–ª—è —Ç–µ—Å—Ç–æ–≤

```swift
class MockKeychainManager: KeychainManagerProtocol {
    private var storage = [String: Data]()

    func save(_ data: Data, forKey key: String) {
        storage[key] = data
    }

    func retrieve(forKey key: String) -> Data? {
        return storage[key]
    }

    func delete(forKey key: String) {
        storage.removeValue(forKey: key)
    }
}
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º Keychain

```swift
class KeychainManagerTests: XCTestCase {
    private var keychainManager: KeychainManager!

    override func setUp() {
        super.setUp()
        keychainManager = KeychainManager()
    }

    func testSaveAndRetrieveData() {
        let testData = "test data".data(using: .utf8)!

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        keychainManager.save(testData, forKey: "test_key")

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        let retrievedData = keychainManager.retrieve(forKey: "test_key")

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º
        XCTAssertEqual(testData, retrievedData)
    }

    override func tearDown() {
        super.tearDown()
        // –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        keychainManager.delete(forKey: "test_key")
    }
}
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Keychain Services ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. **–í—ã–±–∏—Ä–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
2. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é** –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∑–∞—â–∏—Ç—ã
3. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ** –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å iCloud** —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
5. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ** –æ—Å–æ–±–µ–Ω–Ω–æ —Å –±–∏–æ–º–µ—Ç—Ä–∏–µ–π

–ü–æ–º–Ω–∏—Ç–µ: "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ. –≠—Ç–æ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞."

## –°—Å—ã–ª–∫–∏
- [Keychain Services Programming Guide](https://developer.apple.com/documentation/security/keychain_services)
- [Local Authentication Framework](https://developer.apple.com/documentation/localauthentication)
- [WWDC: Security on iOS](https://developer.apple.com/videos/play/wwdc2018/702/)
- [WWDC: Protecting your user's privacy](https://developer.apple.com/videos/play/wwdc2020/10676/)
